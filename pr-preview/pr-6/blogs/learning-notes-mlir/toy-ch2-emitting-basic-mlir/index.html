<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Toy Ch2 | Emitting Basic MLIR | ÁßãÊ∞¥¬∑JamesNULLiu</title><meta name=keywords content="mlir"><meta name=description content="My learning notes of MLIR."><meta name=author content="jamesnulliu"><link rel=canonical href=https://jamesnulliu.github.io/blogs/learning-notes-mlir/toy-ch2-emitting-basic-mlir/><link crossorigin=anonymous href=/assets/css/stylesheet.62cb9c488bb33c0e9a9d3c29b7f4259cbb0db25aaa19ba672188203d3d5bcaf9.css integrity="sha256-YsucSIuzPA6anTwpt/QlnLsNslqqGbpnIYggPT1byvk=" rel="preload stylesheet" as=style><link rel=icon href=https://jamesnulliu.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://jamesnulliu.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://jamesnulliu.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://jamesnulliu.github.io/apple-touch-icon.png><link rel=mask-icon href=https://jamesnulliu.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://jamesnulliu.github.io/blogs/learning-notes-mlir/toy-ch2-emitting-basic-mlir/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js></script><script>MathJax={tex:{displayMath:[["\\[","\\]"],["$$","$$"]],inlineMath:[["\\(","\\)"],["$","$"]]}}</script><meta property="og:url" content="https://jamesnulliu.github.io/blogs/learning-notes-mlir/toy-ch2-emitting-basic-mlir/"><meta property="og:site_name" content="ÁßãÊ∞¥¬∑JamesNULLiu"><meta property="og:title" content="Toy Ch2 | Emitting Basic MLIR"><meta property="og:description" content="My learning notes of MLIR."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="blogs"><meta property="article:published_time" content="2024-07-30T14:45:00+08:00"><meta property="article:modified_time" content="2025-09-12T22:39:56+00:00"><meta property="article:tag" content="Mlir"><meta name=twitter:card content="summary"><meta name=twitter:title content="Toy Ch2 | Emitting Basic MLIR"><meta name=twitter:description content="My learning notes of MLIR."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blogs","item":"https://jamesnulliu.github.io/blogs/"},{"@type":"ListItem","position":2,"name":"üìÅ Learning Notes: MLIR","item":"https://jamesnulliu.github.io/blogs/learning-notes-mlir/"},{"@type":"ListItem","position":3,"name":"Toy Ch2 | Emitting Basic MLIR","item":"https://jamesnulliu.github.io/blogs/learning-notes-mlir/toy-ch2-emitting-basic-mlir/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Toy Ch2 | Emitting Basic MLIR","name":"Toy Ch2 | Emitting Basic MLIR","description":"My learning notes of MLIR.","keywords":["mlir"],"articleBody":" Reference: https://mlir.llvm.org/docs/Tutorials/Toy/Ch-2/\nNote: Check Setup the Environment of MLIR for the environment setup.\n1. Run Example Define a new env var:\nexport TOY_CH2_HOME=\"$MLIR_HOME/examples/toy/Ch2\" Create a file $TOY_CH2_HOME/input.toy ; Add the following content to the file:\n# User defined generic function that operates on unknown shaped arguments. def multiply_transpose(a, b) { return transpose(a) * transpose(b); } def main() { var a\u003c2, 3\u003e = [[1, 2, 3], [4, 5, 6]]; var b\u003c2, 3\u003e = [1, 2, 3, 4, 5, 6]; var c = multiply_transpose(a, b); var d = multiply_transpose(b, a); print(d); } Emit to AST (Abstract Syntax Tree):\ntoy-ch2 $TOY_CH2_HOME/input.toy -emit=ast Emit to MLIR (Multi-Level Intermediate Representation):\ntoyc-ch2 $TOY_CH2_HOME/input.toy -emit=mlir 2. Add an Operator 2.1. Define the Operation Add following code to $TOY_CH2_HOME/include/toy/Ops.td:\n// SubtractOp def SubtractOp : Toy_Op\u003c\"subtract\"\u003e { let summary = \"element-wise subtraction operation\"; let description = [{ The \"subtract\" operation performs element-wise subtraction between two tensors. The shapes of the tensor operands are expected to match. }]; let arguments = (ins F64Tensor:$lhs, F64Tensor:$rhs); let results = (outs F64Tensor); // Indicate that the operation has a custom parser and printer method. let hasCustomAssemblyFormat = 1; // Allow building an AddOp with from the two input operands. let builders = [ OpBuilder\u003c(ins \"Value\":$lhs, \"Value\":$rhs)\u003e ]; } Build MLIR again to imply the modifications:\nbash $LLVM_PROJ_HOME/scripts/build-mlir.sh Build errors pop out, because:\nhasCustomAssemblyFormat is assigned with 1, but the custom parser and printer method is not implemented. OpBuilder is not implemented. These errors will be handled later.\nNote that the C++ implementation of class SubtractOp has been generated in $LLVM_PROJ_HOME/build/tools/mlir/examples/toy/Ch2/include/toy/Ops.h.inc, and as a result, you are now able to use class SubtractOp with code completion and syntax highlighting of clangd.\n2.2. Implement the Operations To implement custom parser and printer methods as well as OpBuilder, add the following code to $TOY_CH2_HOME/mlir/Dialect.cpp:\n// SubtractOp void SubtractOp::build(mlir::OpBuilder \u0026builder, mlir::OperationState \u0026state, mlir::Value lhs, mlir::Value rhs) { state.addTypes(UnrankedTensorType::get(builder.getF64Type())); state.addOperands({lhs, rhs}); } mlir::ParseResult SubtractOp::parse(mlir::OpAsmParser \u0026parser, mlir::OperationState \u0026result) { return parseBinaryOp(parser, result); } void SubtractOp::print(mlir::OpAsmPrinter \u0026p) { printBinaryOp(p, *this); } 2.3. Emit - Operator Go to $TOY_CH2_HOME/mlir/MLIRGen.cpp, locate function mlirGen and add the specific case for -, as shown below:\nmlir::Value mlirGen(BinaryExprAST \u0026binop) { // ... switch (binop.getOp()) { case '+': return builder.create\u003cAddOp\u003e(location, lhs, rhs); case '*': return builder.create\u003cMulOp\u003e(location, lhs, rhs); case '-': return builder.create\u003cSubtractOp\u003e(location, lhs, rhs); } // ... } Rebuild the MLIR:\n$LLVM_PROJ_HOME/scripts/build-mlir.sh 2.4. Test the - Operator Change the content of $MLIR_HOME/input.toy to:\n# User defined generic function that operates on unknown shaped arguments. def multiply_transpose(a, b) { return transpose(a) * transpose(b); } def main() { var a\u003c2, 3\u003e = [[1, 2, 3], [4, 5, 6]]; var b\u003c2, 3\u003e = [1, 2, 3, 4, 5, 6]; var c = multiply_transpose(a, b); var d = multiply_transpose(b, a); var e = a - b; print(e); } Generate MLIR:\ntoyc-ch2 $TOY_CH2_HOME/input.toy -emit=mlir ","wordCount":"463","inLanguage":"en","datePublished":"2024-07-30T14:45:00+08:00","dateModified":"2025-09-12T22:39:56Z","author":[{"@type":"Person","name":"jamesnulliu"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://jamesnulliu.github.io/blogs/learning-notes-mlir/toy-ch2-emitting-basic-mlir/"},"publisher":{"@type":"Organization","name":"ÁßãÊ∞¥¬∑JamesNULLiu","logo":{"@type":"ImageObject","url":"https://jamesnulliu.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://jamesnulliu.github.io/ accesskey=h title="ÁßãÊ∞¥¬∑JamesNULLiu (Alt + H)">ÁßãÊ∞¥¬∑JamesNULLiu</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://jamesnulliu.github.io/zh/ title=ÁÆÄ‰Ωì‰∏≠Êñá aria-label=ÁÆÄ‰Ωì‰∏≠Êñá>ÁÆÄ‰Ωì‰∏≠Êñá</a></li></ul></div></div><ul id=menu><li><a href=https://jamesnulliu.github.io/ title=Home><span>Home</span></a></li><li><a href=https://jamesnulliu.github.io/about_me/ title="About Me"><span>About Me</span></a></li><li><a href=https://jamesnulliu.github.io/blogs/ title=Blogs><span>Blogs</span></a></li><li><a href=https://jamesnulliu.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://jamesnulliu.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://jamesnulliu.github.io/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://jamesnulliu.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://jamesnulliu.github.io/friends/ title=Friends><span>Friends</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://jamesnulliu.github.io/>Home</a>&nbsp;¬ª&nbsp;<a href=https://jamesnulliu.github.io/blogs/>Blogs</a>&nbsp;¬ª&nbsp;<a href=https://jamesnulliu.github.io/blogs/learning-notes-mlir/>üìÅ Learning Notes: MLIR</a></div><h1 class="post-title entry-hint-parent">Toy Ch2 | Emitting Basic MLIR</h1><div class=post-description>My learning notes of MLIR.</div><div class=post-meta><span title='2024-07-30 14:45:00 +0800 +0800'>Jul-30-2024</span>&nbsp;¬∑&nbsp;3 min&nbsp;¬∑&nbsp;463 words&nbsp;¬∑&nbsp;jamesnulliu</div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#1-run-example aria-label="1. Run Example">1. Run Example</a></li><li><a href=#2-add-an-operator aria-label="2. Add an Operator">2. Add an Operator</a><ul><li><a href=#21-define-the-operation aria-label="2.1. Define the Operation">2.1. Define the Operation</a></li><li><a href=#22-implement-the-operations aria-label="2.2. Implement the Operations">2.2. Implement the Operations</a></li><li><a href=#23-emit---operator aria-label="2.3. Emit - Operator">2.3. Emit <code>-</code> Operator</a></li><li><a href=#24-test-the---operator aria-label="2.4. Test the - Operator">2.4. Test the <code>-</code> Operator</a></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{let e=null;const t=window.innerHeight+window.pageYOffset>=document.body.offsetHeight-100;if(t)e=elements[elements.length-1];else{let t=null,n=1/0;elements.forEach(e=>{const s=getOffsetTop(e)-window.pageYOffset;if(s<=window.innerHeight*.3){const o=Math.abs(s);o<n&&(n=o,t=e)}}),e=t||elements[0]}if(e&&e!==activeElement){if(activeElement){const t=encodeURI(activeElement.getAttribute("id")).toLowerCase(),e=document.querySelector(`.inner ul li a[href="#${t}"]`);e&&e.classList.remove("active")}activeElement=e;const n=encodeURI(activeElement.getAttribute("id")).toLowerCase(),t=document.querySelector(`.inner ul li a[href="#${n}"]`);t&&(t.classList.add("active"),document.getElementById("toc-container").classList.contains("wide")&&scrollTocToActiveItem(t))}},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}function scrollTocToActiveItem(e){const t=document.querySelector(".toc .inner");if(!t||!e)return;const n=t.getBoundingClientRect(),s=e.getBoundingClientRect(),o=n.height/2,i=s.top-n.top+t.scrollTop,a=i-o;t.scrollTo({top:Math.max(0,a),behavior:"smooth"})}</script><div class=post-content><blockquote><p>Reference: <a href=https://mlir.llvm.org/docs/Tutorials/Toy/Ch-2/>https://mlir.llvm.org/docs/Tutorials/Toy/Ch-2/</a></p></blockquote><p><strong>Note</strong>: Check <a href=../setup-the-environment-of-mlir/>Setup the Environment of MLIR</a> for the environment setup.</p><h2 id=1-run-example>1. Run Example<a hidden class=anchor aria-hidden=true href=#1-run-example>#</a></h2><p>Define a new env var:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>export</span> <span class=nv>TOY_CH2_HOME</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$MLIR_HOME</span><span class=s2>/examples/toy/Ch2&#34;</span>
</span></span></code></pre></div><p>Create a file <code>$TOY_CH2_HOME/input.toy</code> ; Add the following content to the file:</p><pre tabindex=0><code class=language-toy data-lang=toy># User defined generic function that operates on unknown shaped arguments.
def multiply_transpose(a, b) {
  return transpose(a) * transpose(b);
}

def main() {
  var a&lt;2, 3&gt; = [[1, 2, 3], [4, 5, 6]];
  var b&lt;2, 3&gt; = [1, 2, 3, 4, 5, 6];
  var c = multiply_transpose(a, b);
  var d = multiply_transpose(b, a);
  print(d);
}
</code></pre><p>Emit to AST (Abstract Syntax Tree):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>toy-ch2 <span class=nv>$TOY_CH2_HOME</span>/input.toy -emit<span class=o>=</span>ast
</span></span></code></pre></div><p>Emit to MLIR (Multi-Level Intermediate Representation):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>toyc-ch2 <span class=nv>$TOY_CH2_HOME</span>/input.toy -emit<span class=o>=</span>mlir
</span></span></code></pre></div><h2 id=2-add-an-operator>2. Add an Operator<a hidden class=anchor aria-hidden=true href=#2-add-an-operator>#</a></h2><h3 id=21-define-the-operation>2.1. Define the Operation<a hidden class=anchor aria-hidden=true href=#21-define-the-operation>#</a></h3><p>Add following code to <code>$TOY_CH2_HOME/include/toy/Ops.td</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-tablegen data-lang=tablegen><span class=line><span class=cl><span class=c>// SubtractOp
</span></span></span><span class=line><span class=cl><span class=c></span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nv>SubtractOp</span> <span class=p>:</span> <span class=nv>Toy_Op</span><span class=p>&lt;</span><span class=s>&#34;subtract&#34;</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>let</span> <span class=nv>summary</span> <span class=p>=</span> <span class=s>&#34;element-wise subtraction operation&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>let</span> <span class=nv>description</span> <span class=p>=</span> <span class=s>[{
</span></span></span><span class=line><span class=cl><span class=s>    The &#34;subtract&#34; operation performs element-wise subtraction between two
</span></span></span><span class=line><span class=cl><span class=s>    tensors. The shapes of the tensor operands are expected to match.
</span></span></span><span class=line><span class=cl><span class=s>  }]</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>let</span> <span class=nv>arguments</span> <span class=p>=</span> <span class=p>(</span><span class=nv>ins</span> <span class=nv>F64Tensor</span><span class=p>:</span><span class=nv>$lhs</span><span class=p>,</span> <span class=nv>F64Tensor</span><span class=p>:</span><span class=nv>$rhs</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>let</span> <span class=nv>results</span> <span class=p>=</span> <span class=p>(</span><span class=nv>outs</span> <span class=nv>F64Tensor</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c>// Indicate that the operation has a custom parser and printer method.
</span></span></span><span class=line><span class=cl><span class=c></span>  <span class=k>let</span> <span class=nv>hasCustomAssemblyFormat</span> <span class=p>=</span> <span class=m>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c>// Allow building an AddOp with from the two input operands.
</span></span></span><span class=line><span class=cl><span class=c></span>  <span class=k>let</span> <span class=nv>builders</span> <span class=p>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=nv>OpBuilder</span><span class=p>&lt;(</span><span class=nv>ins</span> <span class=s>&#34;Value&#34;</span><span class=p>:</span><span class=nv>$lhs</span><span class=p>,</span> <span class=s>&#34;Value&#34;</span><span class=p>:</span><span class=nv>$rhs</span><span class=p>)&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Build MLIR again to imply the modifications:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>bash <span class=nv>$LLVM_PROJ_HOME</span>/scripts/build-mlir.sh
</span></span></code></pre></div><p>Build errors pop out, because:</p><ul><li><code>hasCustomAssemblyFormat</code> is assigned with <code>1</code>, but the custom parser and printer method is not implemented.</li><li><code>OpBuilder</code> is not implemented.</li></ul><p>These errors will be handled later.</p><p>Note that the C++ implementation of class <code>SubtractOp</code> has been generated in <code>$LLVM_PROJ_HOME/build/tools/mlir/examples/toy/Ch2/include/toy/Ops.h.inc</code>, and as a result, you are now able to use class <code>SubtractOp</code> with code completion and syntax highlighting of clangd.</p><h3 id=22-implement-the-operations>2.2. Implement the Operations<a hidden class=anchor aria-hidden=true href=#22-implement-the-operations>#</a></h3><p>To implement custom parser and printer methods as well as <code>OpBuilder</code>, add the following code to <code>$TOY_CH2_HOME/mlir/Dialect.cpp</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>// SubtractOp
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=n>SubtractOp</span><span class=o>::</span><span class=n>build</span><span class=p>(</span><span class=n>mlir</span><span class=o>::</span><span class=n>OpBuilder</span> <span class=o>&amp;</span><span class=n>builder</span><span class=p>,</span> <span class=n>mlir</span><span class=o>::</span><span class=n>OperationState</span> <span class=o>&amp;</span><span class=n>state</span><span class=p>,</span> <span class=n>mlir</span><span class=o>::</span><span class=n>Value</span> <span class=n>lhs</span><span class=p>,</span> <span class=n>mlir</span><span class=o>::</span><span class=n>Value</span> <span class=n>rhs</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>state</span><span class=p>.</span><span class=n>addTypes</span><span class=p>(</span><span class=n>UnrankedTensorType</span><span class=o>::</span><span class=n>get</span><span class=p>(</span><span class=n>builder</span><span class=p>.</span><span class=n>getF64Type</span><span class=p>()));</span>
</span></span><span class=line><span class=cl>  <span class=n>state</span><span class=p>.</span><span class=n>addOperands</span><span class=p>({</span><span class=n>lhs</span><span class=p>,</span> <span class=n>rhs</span><span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>mlir</span><span class=o>::</span><span class=n>ParseResult</span> <span class=n>SubtractOp</span><span class=o>::</span><span class=n>parse</span><span class=p>(</span><span class=n>mlir</span><span class=o>::</span><span class=n>OpAsmParser</span> <span class=o>&amp;</span><span class=n>parser</span><span class=p>,</span> <span class=n>mlir</span><span class=o>::</span><span class=n>OperationState</span> <span class=o>&amp;</span><span class=n>result</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nf>parseBinaryOp</span><span class=p>(</span><span class=n>parser</span><span class=p>,</span> <span class=n>result</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=n>SubtractOp</span><span class=o>::</span><span class=n>print</span><span class=p>(</span><span class=n>mlir</span><span class=o>::</span><span class=n>OpAsmPrinter</span> <span class=o>&amp;</span><span class=n>p</span><span class=p>)</span> <span class=p>{</span> <span class=n>printBinaryOp</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=o>*</span><span class=k>this</span><span class=p>);</span> <span class=p>}</span>
</span></span></code></pre></div><h3 id=23-emit---operator>2.3. Emit <code>-</code> Operator<a hidden class=anchor aria-hidden=true href=#23-emit---operator>#</a></h3><p>Go to <code>$TOY_CH2_HOME/mlir/MLIRGen.cpp</code>, locate function <code>mlirGen</code> and add the specific case for <code>-</code>, as shown below:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>mlir</span><span class=o>::</span><span class=n>Value</span> <span class=n>mlirGen</span><span class=p>(</span><span class=n>BinaryExprAST</span> <span class=o>&amp;</span><span class=n>binop</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>switch</span> <span class=p>(</span><span class=n>binop</span><span class=p>.</span><span class=n>getOp</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=sc>&#39;+&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>builder</span><span class=p>.</span><span class=n>create</span><span class=o>&lt;</span><span class=n>AddOp</span><span class=o>&gt;</span><span class=p>(</span><span class=n>location</span><span class=p>,</span> <span class=n>lhs</span><span class=p>,</span> <span class=n>rhs</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=sc>&#39;*&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>builder</span><span class=p>.</span><span class=n>create</span><span class=o>&lt;</span><span class=n>MulOp</span><span class=o>&gt;</span><span class=p>(</span><span class=n>location</span><span class=p>,</span> <span class=n>lhs</span><span class=p>,</span> <span class=n>rhs</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=sc>&#39;-&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>builder</span><span class=p>.</span><span class=n>create</span><span class=o>&lt;</span><span class=n>SubtractOp</span><span class=o>&gt;</span><span class=p>(</span><span class=n>location</span><span class=p>,</span> <span class=n>lhs</span><span class=p>,</span> <span class=n>rhs</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><p>Rebuild the MLIR:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>$LLVM_PROJ_HOME</span>/scripts/build-mlir.sh
</span></span></code></pre></div><h3 id=24-test-the---operator>2.4. Test the <code>-</code> Operator<a hidden class=anchor aria-hidden=true href=#24-test-the---operator>#</a></h3><p>Change the content of <code>$MLIR_HOME/input.toy</code> to:</p><pre tabindex=0><code class=language-toy data-lang=toy># User defined generic function that operates on unknown shaped arguments.
def multiply_transpose(a, b) {
  return transpose(a) * transpose(b);
}

def main() {
  var a&lt;2, 3&gt; = [[1, 2, 3], [4, 5, 6]];
  var b&lt;2, 3&gt; = [1, 2, 3, 4, 5, 6];
  var c = multiply_transpose(a, b);
  var d = multiply_transpose(b, a);
  var e = a - b;
  print(e);
}
</code></pre><p>Generate MLIR:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>toyc-ch2 <span class=nv>$TOY_CH2_HOME</span>/input.toy -emit<span class=o>=</span>mlir
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://jamesnulliu.github.io/tags/mlir/>Mlir</a></li></ul><nav class=paginav><a class=prev href=https://jamesnulliu.github.io/blogs/learning-notes-mlir/toy-ch3-high-level-language-specific-analysis-and-transformation/><span class=title>¬´ Prev</span><br><span>Toy Ch3 | High-Level Language Specific Analysis and Transformation</span>
</a><a class=next href=https://jamesnulliu.github.io/blogs/learning-notes-mlir/setup-the-environment-of-mlir/><span class=title>Next ¬ª</span><br><span>Setup the Environment of MLIR</span></a></nav></footer><script src=https://giscus.app/client.js data-repo=jamesnulliu/jamesnulliu.github.io data-repo-id=R_kgDOMPCQIw data-category=Announcements data-category-id=DIC_kwDOMPCQI84Cgb2t data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=en crossorigin=anonymous async></script></article></main><footer class=footer><span>¬© 2024-2025 JamesNULLiu</span> ¬∑
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>
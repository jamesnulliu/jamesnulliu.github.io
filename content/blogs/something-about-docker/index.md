---
title: "Something about Docker"
date: 2024-08-08T12:00:00+08:00
lastmod: 2024-11-21T13:38:00+08:00
draft: false
author: ["jamesnulliu"]
keywords: 
    - docker
categories:
    - system
    - software
tags:
    - docker
description: Something about docker. 
summary: Something about docker.
comments: true
images: 
cover:
    image: ""
    caption: ""
    alt: ""
    relative: true
    hidden: true
---

> Check this blog if you want a [Docker Container with Nvidia GPU Support](/blogs/docker-container-with-nvidia-gpu-support).

## 1. About Image

### 1.1. Check Existing Images and Statistics

```bash
# List all images
docker images
# Check disk usage of docker (images, conatiners)
docker system df
```

### 1.2. Rename an Image

```bash
docker tag <image-id> <image-name>:<image-tag>
```

### 1.3. Pull an Image

Search for an image in [Docker Hub](https://hub.docker.com/).

Pull the image by running:

```bash
docker pull <image-name>:<image-tag>
```

Or download the layers to `<dir-path>` by using [this script](https://github.com/moby/moby/blob/master/contrib/download-frozen-image-v2.sh):

```bash
mkdir -p <dir-path>  # Directory to store the layers

bash download-frozen-image-v2.sh <dir-path> <image-name>:<image-tag>

# Load the image
tar -cC <dir-path> . | docker load
```

### 1.4. Build an Image

Use a Dockerfile to build a new image based on an existing image.

Check this example: [Dokerfile.example](/files/blogs/something-about-docker/Dockerfile.example).

Run the following command to build `<image-name>:<image-tag>`:

```bash
docker build -f <docker-file-path> -t <image-name>:<image-tag> .
```

> Note that `.` specifiles the build context, where docker can reference (e.g., `COPY` and `ADD`) the containing files during the build process. You can change it to other directory path according to your needs.

You will find the new image after building by runing `docker images`. 

### 1.5. Save an Image to a tar File

To export an image to a tar file with reusable layer imformations, run the following command:

```bash
docker save -o <some-name>.tar <image-name>:<image-tag>
# Or
docker save -o <some-name>.tar <image-id>
```

See [1.6. Load an Image](#16-load-an-image) to load the generated tar file to an image.

### 1.6. Load an Image

Suppose you have a tar file `<some-name>.tar`, if the file is generated by `docker save` (see [1.5. Save an Image to a tar File](#15-save-an-image-to-a-tar-file)), load the image by running:

```bash
docker load -i <some-name>.tar
```

Or if the file is generated by `docker export` (see [2.4 Export a container to a tar File](#24-export-a-container-to-a-tar-file)), load the container to an image by running:

```bash
docker import <some-name>.tar <image-name>:<image-tag>
```

### 1.7. Remove an Image

Before removing an image, you need to:

- Stop containers using the image: `docker stop <container-id>`.
- Remove containers using the image: `docker rm <container-id>`.

Then remove the image:

```bash
docker rmi <image-name>:<image-tag>
# Or
docker rmi <image-id>
```

## 2. About Container

### 2.1. Check Existing Containers and Statistics

```bash
# List running/[all] containers
docker ps [-a]
# Check statistics of all/[some] containers
docker stats [<container-id>]
# Check disk usage of docker (images, conatiners)
docker system df
```

### 2.2. Create a Container


Basic Parameters:  
{{< details >}}
- `-it`: Interactive mode with pseudo-TTY terminal
- `--name <container-name>`: Assign a name to the container for easier reference
- `-p <host-port>:<container-port>`: Map host port to container port (e.g. `8888:22`)
- `--entrypoint /bin/bash`: Override default entrypoint with bash shell
- `<image-name>`: Name of the Docker image to use (e.g. `ubuntu`, `nvidia/cuda`)
- `<image-tag>`: Version/tag of the image (e.g. `latest`, `20.04`)
{{< /details >}}

Additional Options:  
{{< details >}}
- `--shm-size <shm-size>G`: Set size of /dev/shm (shared memory) in GB (e.g. `2G`)
- `--gpus all`: [Optional] Give container access to all GPUs (requires nvidia-docker)
- `-v <host-path>:<container-path>`: Mount host directory into container
- `-e KEY=VALUE`: Set environment variables
- `--network=host`: Use host network stack
- `--ipc=host`: Use host IPC namespace
- `--privileged`: Give extended privileges to container
- `-u $(id -u):$(id -g)`: Run as current user instead of root
- `--rm`: Automatically remove container when it exits
{{< /details >}}

Example:

```bash {linenos=true}
# Create and run a container from <image-name>:<image-tag>
docker run -it \
    --gpus all \
    --name <container-name> \
    -p <host-port>:<container-port> \
    --entrypoint /bin/bash \
    --shm-size <shm-size>G \
    <image-name>:<image-tag>
# Now you are in the container.
```

To exit container and return to host, run `exit`, which will stop the containter; Or type `Ctrl+P+Q`, which will detach from container without stopping it.

### 2.3. Start, Stop, Remove and Rename a Container

Start a container:

```bash {linenos=true}
docker start <container-name>
```

Attach to a container:

```bash {linenos=true}
docker exec -it <container-name> bash
```

Stop a container:

```bash {linenos=true}
docker stop <contianer-name>
```

Remove a container:

```bash {linenos=true}
docker rm <container-name>
```

Rename a container:

```bash {linenos=true}
docker rename <container-id> <new-name>
# or
docker rename <old-name> <new-name>
```

### 2.4. Export a Container to a tar File

Note that `docker export` only exports the container's filesystem without layer information. It is more recommended to use `docker save` to save a image to a tar file (see [1.5. Save an Image to a tar File](#15-save-an-image-to-a-tar-file)).

```bash {linenos=true}
docker export <container-id> > <some-name>.tar
```
See [1.6. Load an Image](#16-load-an-image) to load the generated tar file to an image.

## 3. Change Docker Root Directory to a Different Location

Check current docker root directory:

```bash {linenos=true}
docker info | grep "Docker Root Dir"
```

Stop docker daemon:

```bash {linenos=true}
systemctl stop docker
```

Edit (or create) the docker configuration file:

```bash {linenos=true}
vim /etc/docker/daemon.json
```

Add or modify the configuration:

```json {linenos=true}
{
    "data-root": "<target-docker-root>"
}
```

Copy the existing docker data to target location:

```bash {linenos=true}
rsync -aP <current-docker-root> <target-docker-root>
```

Restart docker daemon:

```bash {linenos=true}
systemctl daemon-reload
systemctl start docker
```

Verify the new location:

```bash {linenos=true}
docker info | grep "Docker Root Dir"
```